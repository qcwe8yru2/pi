<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Realtime Database 게시판</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        /* 사이드 바 기본 스타일 */
        #custom-bar {
            width: 80px;
            padding: 10px;
            background-color: #eaeaea;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        /* 사이드 바 숨길 때 애니메이션 */
        #custom-bar.hidden {
            transform: translateX(-100%);
        }

        #custom-bar input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
        }

        #custom-bar input[type="range"] {
            width: 60px;
        }

        #custom-bar button {
            padding: 5px;
            background-color: #3b5998;
            color: white;
            border: none;
            cursor: pointer;
        }

        /* 메시지 보드와 토글 버튼 */
        #message-board {
            width: 100%;
            max-width: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background-color: #ffffff;
            margin-left: 100px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            transition: margin-left 0.3s ease;
        }

        /* 사이드 바가 숨겨졌을 때 메시지 보드의 위치 조정 */
        #message-board.sidebar-hidden {
            margin-left: 20px;
        }

        #toggle-sidebar-btn {
            position: fixed;
            top: 10px;
            left: 100px;
            z-index: 100;
            background-color: #3b5998;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: left 0.3s ease;
        }

        /* 토글 버튼 위치 조정 */
        #toggle-sidebar-btn.sidebar-hidden {
            left: 20px;
        }

        h1 {
            text-align: center;
            padding: 10px;
            margin: 0;
            background-color: #3b5998;
            color: white;
            font-size: 1.5rem;
        }

        #messages-list {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #messages-list li {
            margin: 5px 0;
            padding: 10px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }

        #messages-list li.sent {
            background-color: var(--my-background-color, #dcf8c6);
            margin-left: auto;
        }

        #messages-list li.received {
            background-color: var(--their-background-color, #ffffff);
            margin-right: auto;
        }

        .timestamp, .ip-info {
            font-size: inherit;
            color: black;
            margin-right: 5px;
        }

        .ip-info {
            font-size: 0.7rem;
            color: lightgray;
            display: block;
            margin-top: 5px;
        }

        .delete-btn {
            background-color: transparent;
            border: none;
            color: lightgray;
            cursor: pointer;
            font-size: 0.6rem;
            position: absolute;
            right: 10px;
            top: 10px;
        }

        #input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: #f9f9f9;
        }

        input, button {
            border: none;
            padding: 10px;
            font-size: 1rem;
            border-radius: 20px;
        }

        input#username {
            width: 20%;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        input#message {
            width: calc(100% - 120px);
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        button {
            background-color: #3b5998;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #2d4373;
        }
    </style>
</head>
<body>
    <!-- 사이드바 토글 버튼 -->
    <button id="toggle-sidebar-btn">Hide Sidebar</button>

    <!-- 커스텀 바 -->
    <div id="custom-bar">
        <label>글씨 크기</label>
        <input id="font-size-control" type="range" min="10" max="30" value="16">
        
        <label>글씨 색상</label>
        <input id="font-color-control" type="color" value="#000000">
        
        <label>굵게</label>
        <button id="bold-toggle">Bold</button>
        
        <label>내 배경</label>
        <input id="my-background-color-control" type="color" value="#dcf8c6">
        
        <label>상대 배경</label>
        <input id="their-background-color-control" type="color" value="#ffffff">
    </div>

    <div id="message-board">
        <h1>카카오톡 스타일 게시판</h1>
        <ul id="messages-list"></ul>

        <div id="input-area">
            <input type="text" id="username" placeholder="이름 입력">
            <input type="text" id="message" placeholder="메시지 입력">
            <button id="sendBtn">전송</button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK 모듈 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDb7xwJY_RzxESIXN8GdcBpX3F2gglclX8",
            authDomain: "pi-zeta.firebaseapp.com",
            databaseURL: "https://pi-zeta-default-rtdb.firebaseio.com",
            projectId: "pi-zeta",
            storageBucket: "pi-zeta.appspot.com",
            messagingSenderId: "1048639958496",
            appId: "1:1048639958496:web:7739a25dc04ed833be8f85",
            measurementId: "G-LW0YQPC6L0"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // 사이드바 토글 함수
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
        const customBar = document.getElementById('custom-bar');
        const messageBoard = document.getElementById('message-board');

        toggleSidebarBtn.addEventListener('click', () => {
            customBar.classList.toggle('hidden');
            messageBoard.classList.toggle('sidebar-hidden');
            toggleSidebarBtn.classList.toggle('sidebar-hidden');
            
            // 토글 버튼의 텍스트 변경
            if (customBar.classList.contains('hidden')) {
                toggleSidebarBtn.textContent = 'Show Sidebar';
            } else {
                toggleSidebarBtn.textContent = 'Hide Sidebar';
            }
        });

        // 시간 형식 변환 함수
        function formatTimestamp(date) {
            const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
            return new Intl.DateTimeFormat('ko-KR', options).format(date);
        }

        // 사용자의 IP 주소 및 위치 정보 가져오기
        async function getUserIPAndLocation() {
            try {
                const response = await fetch("https://ipapi.co/json/");
                const data = await response.json();
                const ip = data.ip || "000000";
                const country = data.country_name || '';
                const city = data.city || '';
                const region = data.region || '';
                const latitude = data.latitude || '';
                const longitude = data.longitude || '';

                // 정보를 배열에 넣고, 없는 값은 제외한 후 문자열로 반환
                const locationInfoArray = [country, city, region, latitude && `위도: ${latitude}`, longitude && `경도: ${longitude}`].filter(Boolean);
                const locationInfo = locationInfoArray.join(', ');

                return { ip, locationInfo };
            } catch (error) {
                console.error('IP 및 위치 정보 가져오기 실패:', error);
                return { ip: '000000', locationInfo: '' };
            }
        }

        // 메시지 전송 함수
        async function sendMessage() {
            const username = document.getElementById('username').value;
            const message = document.getElementById('message').value;
            const { ip, locationInfo } = await getUserIPAndLocation(); // IP 및 위치 정보 가져오기

            if (username && message) {
                const timestamp = formatTimestamp(new Date());

                // Firebase Realtime Database에 메시지 추가
                const messagesRef = ref(database, 'messages');
                push(messagesRef, {
                    username: username,
                    message: message,
                    timestamp: timestamp, // 형식 변환된 시간 저장
                    ip: ip,
                    locationInfo: locationInfo // IP와 함께 위치 정보 저장
                });

                document.getElementById('message').value = ''; // 메시지 입력란 초기화
                scrollToBottom(); // 메시지를 전송한 후 스크롤을 아래로 이동
            } else {
                alert('이름과 메시지를 모두 입력하세요!');
            }
        }

        // 메시지 삭제 함수
        function deleteMessage(key) {
            const messageRef = ref(database, `messages/${key}`);
            remove(messageRef);
        }

        // 스크롤을 하단으로 이동하는 함수
        function scrollToBottom() {
            const messagesList = document.getElementById('messages-list');
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        // 메시지 전송 버튼 클릭 이벤트 핸들러
        document.getElementById('sendBtn').addEventListener('click', sendMessage);

        // Enter 키로도 메시지 전송 가능
        document.getElementById('message').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // 실시간으로 데이터 불러오기
        const messagesRef = ref(database, 'messages');
        onValue(messagesRef, (snapshot) => {
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = ''; // 기존 메시지 목록 초기화

            snapshot.forEach((childSnapshot) => {
                const childData = childSnapshot.val();
                const key = childSnapshot.key; // 메시지의 고유 키

                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="timestamp">[${childData.timestamp}]</span> 
                    ${childData.username}: ${childData.message}
                    <span class="ip-info">${childData.ip} ${childData.locationInfo ? `(${childData.locationInfo})` : ''}</span>
                    <button class="delete-btn" onclick="deleteMessage('${key}')">x</button>
                `;

                if (childData.username === document.getElementById('username').value) {
                    li.classList.add('sent');
                } else {
                    li.classList.add('received');
                }

                messagesList.appendChild(li);
            });

            scrollToBottom(); // 메시지를 불러올 때 스크롤을 아래로 이동
        });

        // 사용자 스타일 적용 함수들
        const fontSizeControl = document.getElementById('font-size-control');
        const fontColorControl = document.getElementById('font-color-control');
        const boldToggle = document.getElementById('bold-toggle');
        const myBackgroundColorControl = document.getElementById('my-background-color-control');
        const theirBackgroundColorControl = document.getElementById('their-background-color-control');
        let isBold = false;

        // 글씨 크기 변경
        fontSizeControl.addEventListener('input', () => {
            document.body.style.setProperty('--font-size', `${fontSizeControl.value}px`);
            document.getElementById('messages-list').style.fontSize = `${fontSizeControl.value}px`;
        });

        // 글씨 색상 변경
        fontColorControl.addEventListener('input', () => {
            document.getElementById('messages-list').style.color = fontColorControl.value;
        });

        // 글씨 굵기 변경
        boldToggle.addEventListener('click', () => {
            isBold = !isBold;
            document.getElementById('messages-list').style.fontWeight = isBold ? 'bold' : 'normal';
        });

        // 내 메시지 배경색 변경
        myBackgroundColorControl.addEventListener('input', () => {
            document.documentElement.style.setProperty('--my-background-color', myBackgroundColorControl.value);
        });

        // 상대 메시지 배경색 변경
        theirBackgroundColorControl.addEventListener('input', () => {
            document.documentElement.style.setProperty('--their-background-color', theirBackgroundColorControl.value);
        });

    </script>
</body>
</html>
